<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SafeSakhi AI â€“ Emergency Help</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: linear-gradient(135deg, #fff0f5, #ffe6e6);
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      color: #cc0033;
    }
    button {
      padding: 15px 30px;
      margin: 10px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      box-shadow: 0 5px 12px rgba(0,0,0,0.2);
      transition: 0.2s;
      cursor: pointer;
    }
    #sosButton {
      background: red;
      color: white;
    }
    #whatsappButton {
      background: green;
      color: white;
    }
    .blink {
      animation: blink-animation 1s steps(2, start) infinite;
    }
    @keyframes blink-animation {
      to { background-color: #ffcccc; }
    }
  </style>
</head>
<body>

  <h1>ðŸš¨ SafeSakhi AI â€“ Emergency Help</h1>
  <p>Say "Help me", scream, shake phone, or press SOS.</p>

  <button id="sosButton">ðŸ“¢ SOS â€“ Help Me!</button><br>
  <button id="whatsappButton">ðŸ“² Send SOS via WhatsApp</button>
  <p id="status" style="margin-top:20px;"></p>

  <audio id="alarmSound">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
  </audio>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/sound"></script>

  <script>
    const sosButton = document.getElementById("sosButton");
    const whatsappButton = document.getElementById("whatsappButton");
    const alarmSound = document.getElementById("alarmSound");
    const status = document.getElementById("status");

    let latitude = "", longitude = "";

    // LOCATION
    navigator.geolocation.getCurrentPosition(position => {
      latitude = position.coords.latitude;
      longitude = position.coords.longitude;
    });

    // SOS
    function triggerSOS(reason = "Manual") {
      alarmSound.play();
      document.body.classList.add("blink");
      status.innerText = `ðŸš¨ SOS Triggered (${reason})!`;

      setTimeout(() => {
        document.body.classList.remove("blink");
        status.innerText = "";
      }, 10000);
    }

    sosButton.addEventListener("click", () => triggerSOS("Button"));

    // WhatsApp
    whatsappButton.addEventListener("click", () => {
      if (!latitude || !longitude) {
        alert("Location not detected yet!");
        return;
      }
      const msg = `ðŸš¨ Emergency! I need help.\nðŸ“ Location: https://maps.google.com/?q=${latitude},${longitude}`;
      const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
    });

    // SHAKE detection
    let lastX = null, lastY = null, lastZ = null;
    let threshold = 15;
    window.addEventListener("devicemotion", (event) => {
      let { x, y, z } = event.accelerationIncludingGravity;
      if (lastX !== null) {
        let dx = Math.abs(lastX - x);
        let dy = Math.abs(lastY - y);
        let dz = Math.abs(lastZ - z);
        if (dx + dy + dz > threshold) {
          triggerSOS("Shake");
        }
      }
      lastX = x; lastY = y; lastZ = z;
    });

    // VOICE COMMAND (say "help me")
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = "en-US";

    recognition.onresult = function(e) {
      const transcript = e.results[e.results.length - 1][0].transcript.trim().toLowerCase();
      if (transcript.includes("help me") || transcript.includes("save me")) {
        triggerSOS("Voice Command");
      }
    };
    recognition.start();

    // TEACHABLE MACHINE (Scream Detection)
    const URL = "PASTE_YOUR_MODEL_URL_HERE";
    let model, soundModel;

    async function loadModel() {
      const checkpointURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      soundModel = await tmSound.load(checkpointURL, metadataURL);
      soundModel.listen(result => {
        const screamProb = result[1].probability; // Class 1 = scream
        if (screamProb > 0.95) {
          triggerSOS("Scream Detected");
        }
      }, {
        probabilityThreshold: 0.9,
        overlapFactor: 0.5
      });
    }

    loadModel();
  </script>

</body>
</html>
