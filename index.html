<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SafeSakhi ‚Äî SOS</title>
  <style>
    :root{
      --accent:#d00000;
      --bg:#fff4f4;
      --card:#ffffff;
      --muted:#666;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,var(--bg),#fff);
      padding:28px;
      color:#222;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }
    .app {
      width:100%;
      max-width:480px;
      background:var(--card);
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      padding:22px;
    }
    h1{
      margin:0 0 8px;
      color:var(--accent);
      font-size:20px;
    }
    p.lead{ margin:0 0 18px; color:var(--muted); font-size:14px }
    .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px; }
    button {
      flex:1 1 140px;
      padding:14px 12px;
      border-radius:10px;
      border:0;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,0.08);
    }
    .btn-sos{ background:var(--accent); color:#fff; }
    .btn-stop{ background:#333; color:#fff; }
    .btn-flash{ background:#ffb400; color:#111; }
    .btn-info{ background:#e6e6e6; color:#111; }
    #locationDisplay{ font-size:14px; color:#111; margin-top:12px; word-break:break-word }
    a.smalllink{ display:inline-block; margin-top:8px; font-size:13px; color:var(--accent)}
    footer{ margin-top:18px; font-size:12px; color:var(--muted) }
    /* safe touch targets on mobile */
    @media (max-width:420px){
      .btn-row{ gap:8px }
      button{ padding:14px; font-size:16px }
    }
  </style>
</head>
<body>
  <div class="app" role="main">
    <h1>üö® SafeSakhi ‚Äî SOS</h1>
    <p class="lead">Tap <strong>Activate SOS</strong> to play alarm, fetch location and open WhatsApp with an emergency message.</p>

    <div class="btn-row">
      <button class="btn-sos" id="sosBtn">üîä Activate SOS</button>
      <button class="btn-stop" id="stopBtn">üîá Stop Alarm</button>
    </div>

    <div class="btn-row">
      <button class="btn-flash" id="flashBtn">üí° Flashlight Blink</button>
      <button class="btn-info" id="shareBtn">üì§ Share Location Only</button>
    </div>

    <div id="locationDisplay">üìç Location: Not fetched</div>
    <a class="smalllink" id="mapsLink" href="#" target="_blank" style="display:none">Open in Google Maps</a>

    <footer>Works best on mobile browsers. Flashlight works on Android Chrome (if device supports torch).</footer>
  </div>

  <!-- loud alarm (loop) -->
  <audio id="sosAudio" loop preload="auto">
    <!-- public alarm sound; you can replace with your own hosted file -->
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/bugle_tune.ogg" type="audio/ogg">
    <!-- fallback -->
  </audio>

  <script>
    // Elements
    const sosBtn = document.getElementById('sosBtn');
    const stopBtn = document.getElementById('stopBtn');
    const flashBtn = document.getElementById('flashBtn');
    const shareBtn = document.getElementById('shareBtn');
    const locDisp = document.getElementById('locationDisplay');
    const mapsLink = document.getElementById('mapsLink');
    const audio = document.getElementById('sosAudio');

    // Flashlight control variables
    let streamTrack = null;
    let torchInterval = null;
    let torchOn = false;

    // Get current coordinates, return Promise
    function getCurrentPositionPromise(timeout = 10000) {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
        const opts = { enableHighAccuracy: true, timeout, maximumAge: 0 };
        navigator.geolocation.getCurrentPosition(resolve, reject, opts);
      });
    }

    // Build Google Maps link and WhatsApp message then open WA
    async function handleSOS() {
      try {
        // 1) Play alarm (user gesture already triggered this function)
        try { await audio.play(); } catch (e) { console.warn('Audio play blocked:', e); }

        // 2) Get location
        locDisp.textContent = 'üìç Fetching location... (allow permission)';
        let pos;
        try {
          pos = await getCurrentPositionPromise();
        } catch (err) {
          locDisp.textContent = '‚ö†Ô∏è Unable to get location: ' + (err.message || err);
          // Still allow WhatsApp with 'location unknown'
          openWhatsApp('Location not available. I need help! (SafeSakhi)');
          return;
        }

        const lat = pos.coords.latitude.toFixed(6);
        const lon = pos.coords.longitude.toFixed(6);
        const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
        locDisp.innerHTML = `üìç Location: <strong>${lat}, ${lon}</strong>`;
        mapsLink.href = googleMapsUrl;
        mapsLink.style.display = 'inline-block';

        // 3) WhatsApp message (opens WA app)
        const message = `üö® *SOS ALERT* üö®\nI need help!\nMy location: ${googleMapsUrl}\n(Shared via SafeSakhi)`;
        openWhatsApp(message);

      } catch (ex) {
        console.error('SOS error', ex);
        locDisp.textContent = '‚ö†Ô∏è Error while triggering SOS';
      }
    }

    // Open WhatsApp with prefilled message
    function openWhatsApp(message) {
      const encoded = encodeURIComponent(message);
      // This opens WhatsApp web / app on mobile
      const waUrl = `https://wa.me/?text=${encoded}`;
      // Try opening in new tab/window
      window.open(waUrl, '_blank');
    }

    // Stop alarm
    function stopAlarm() {
      audio.pause();
      audio.currentTime = 0;
    }

    // Flashlight blink implementation
    async function startFlashBlink(blinkMs = 600, totalDuration = 5000) {
      // If already blinking, stop
      if (torchInterval) {
        stopFlashBlink();
        return;
      }

      // request camera with environment facing mode
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } });
        streamTrack = stream.getVideoTracks()[0];
        // ImageCapture API to query capabilities
        const ImageCaptureConstructor = window.ImageCapture;
        let supportsTorch = false;
        if (ImageCaptureConstructor && streamTrack) {
          try {
            const imgCap = new ImageCapture(streamTrack);
            const capabilities = await imgCap.getPhotoCapabilities();
            supportsTorch = capabilities.torch || false;
          } catch (e) {
            // Some browsers may throw ‚Äî still try applyConstraints
            // console.warn('ImageCapture capabilities error', e);
          }
        }

        // If browser supports torch applyConstraints, else fallback
        if (typeof streamTrack.applyConstraints === 'function') {
          // Blink using applyConstraints toggling torch if supported
          let elapsed = 0;
          torchOn = false;
          torchInterval = setInterval(async () => {
            try {
              torchOn = !torchOn;
              await streamTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
            } catch (err) {
              // If applyConstraints with torch unsupported, fallback
              console.warn('Torch toggle error', err);
              // stop blinking
              stopFlashBlink();
            }
            elapsed += blinkMs;
            if (elapsed >= totalDuration) stopFlashBlink();
          }, blinkMs);
        } else {
          // No applyConstraints available
          alert('Flashlight control not supported in this browser.');
          stopAllTracks();
        }

      } catch (err) {
        console.error('Flashlight access error', err);
        alert('Cannot access camera/torch. Make sure permission is allowed and your browser supports torch (Android Chrome).');
        stopAllTracks();
      }
    }

    // Stop flashlight blinking and release camera
    function stopFlashBlink() {
      if (torchInterval) {
        clearInterval(torchInterval);
        torchInterval = null;
      }
      if (streamTrack) {
        try { streamTrack.applyConstraints({ advanced: [{ torch: false }] }); } catch (e) {}
        streamTrack.stop();
        streamTrack = null;
      }
      torchOn = false;
    }

    function stopAllTracks(){
      if (streamTrack) {
        try { streamTrack.stop(); } catch(e) {}
        streamTrack = null;
      }
      if (torchInterval) {
        clearInterval(torchInterval);
        torchInterval = null;
      }
      torchOn = false;
    }

    // Share location only (open WA with just location link)
    async function shareLocationOnly() {
      try {
        locDisp.textContent = 'üìç Fetching location...';
        const pos = await getCurrentPositionPromise();
        const lat = pos.coords.latitude.toFixed(6);
        const lon = pos.coords.longitude.toFixed(6);
        const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
        locDisp.innerHTML = `üìç Location: <strong>${lat}, ${lon}</strong>`;
        mapsLink.href = googleMapsUrl; mapsLink.style.display = 'inline-block';
        const msg = `My location: ${googleMapsUrl}`;
        openWhatsApp(msg);
      } catch (err) {
        locDisp.textContent = '‚ö†Ô∏è Unable to fetch location';
        openWhatsApp('My location not available ‚Äî I need help!');
      }
    }

    // Attach events
    sosBtn.addEventListener('click', () => { handleSOS(); });
    stopBtn.addEventListener('click', () => { stopAlarm(); });
    flashBtn.addEventListener('click', () => {
      // toggle: start blink for 5s or stop if running
      if (torchInterval) {
        stopFlashBlink();
      } else {
        startFlashBlink(500, 5000); // blink every 0.5s for 5s
      }
    });
    shareBtn.addEventListener('click', () => { shareLocationOnly(); });

    // Cleanup on page hide/unload
    window.addEventListener('pagehide', () => { stopAlarm(); stopAllTracks(); });
    window.addEventListener('beforeunload', () => { stopAllTracks(); });

  </script>
</body>
</html>
