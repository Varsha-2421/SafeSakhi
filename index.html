<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SafeSakhi â€” SOS</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #fff3f3; }
    h1 { color: #d60000; }
    button { padding: 15px 25px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; }
    #sosBtn { background: #d60000; color: white; }
    #stopBtn { background: #555; color: white; display: none; }
    .status { margin-top: 15px; font-weight: bold; }
</style>
</head>
<body>

<h1>ðŸš¨ SafeSakhi â€” SOS</h1>
<p>Tap Activate SOS to play alarm, send location, start recording, flashlight, and WhatsApp alert.</p>

<button id="sosBtn">ðŸš¨ Activate SOS</button>
<button id="stopBtn">ðŸ›‘ Stop SOS</button>

<div class="status" id="statusMsg">Idle</div>

<script>
let alarmSound, mediaRecorder, chunks = [], track;
let isRecording = false;

// Start SOS
document.getElementById("sosBtn").addEventListener("click", async () => {
    document.getElementById("statusMsg").innerText = "SOS Activated!";
    document.getElementById("sosBtn").style.display = "none";
    document.getElementById("stopBtn").style.display = "inline-block";

    // Play Alarm Immediately
    try {
        alarmSound = new Audio("alarm.mp3");
        alarmSound.loop = true;
        await alarmSound.play();
    } catch (err) {
        alert("Please turn off silent mode and tap again.");
        console.error(err);
    }

    // Fetch Location and Send WhatsApp
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            let lat = pos.coords.latitude.toFixed(5);
            let lon = pos.coords.longitude.toFixed(5);
            let mapUrl = `https://maps.google.com/?q=${lat},${lon}`;
            let message = encodeURIComponent(`ðŸš¨ SOS! I need help.\nMy location: ${mapUrl}`);
            window.open(`https://wa.me/?text=${message}`, "_blank");
        });
    }

    // Start Audio Recording
    try {
        let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
        mediaRecorder.start();
        isRecording = true;
    } catch (err) {
        console.error("Mic access error", err);
    }

    // Turn On Flashlight (if supported)
    try {
        let camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        track = camStream.getVideoTracks()[0];
        await track.applyConstraints({ advanced: [{ torch: true }] });
    } catch (err) {
        console.warn("Torch not supported", err);
    }

    // Shake-to-Activate
    if (window.DeviceMotionEvent) {
        let lastShake = Date.now();
        window.addEventListener("devicemotion", e => {
            let acc = e.accelerationIncludingGravity;
            let strength = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
            if (strength > 30 && Date.now() - lastShake > 1000) {
                lastShake = Date.now();
                document.getElementById("sosBtn").click();
            }
        });
    }
});

// Stop SOS
document.getElementById("stopBtn").addEventListener("click", () => {
    document.getElementById("statusMsg").innerText = "SOS Stopped";
    document.getElementById("sosBtn").style.display = "inline-block";
    document.getElementById("stopBtn").style.display = "none";

    if (alarmSound) { alarmSound.pause(); alarmSound.currentTime = 0; }
    if (isRecording && mediaRecorder) { mediaRecorder.stop(); isRecording = false; }
    if (track) { track.stop(); }
});
</script>
</body>
</html>
