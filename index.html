<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SafeSakhi â€” SOS</title>
  <style>
    body{font-family:system-ui,Arial; background:#fff6f6; margin:0; padding:22px; display:flex; justify-content:center}
    .card{width:100%;max-width:420px;background:#fff;border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    h1{margin:0 0 6px;color:#c62828}
    p.lead{margin:0 0 16px;color:#555}
    .btn{width:100%;padding:14px;border-radius:10px;border:none;font-size:16px;cursor:pointer;margin:8px 0}
    .btn-red{background:#d32f2f;color:#fff}
    .btn-dark{background:#333;color:#fff}
    .row{display:flex;gap:8px;margin-top:12px}
    .chip{flex:1;background:#f4f4f4;padding:10px;border-radius:10px;font-size:13px;text-align:center}
    footer{font-size:12px;color:#666;margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸš¨ SafeSakhi â€” SOS</h1>
    <p class="lead">Tap <strong>Activate SOS</strong> once. Alarm will play, mic will record, flashlight will attempt to turn on, and WhatsApp will open with location.</p>

    <button id="activateBtn" class="btn btn-red">ðŸš¨ Activate SOS</button>
    <button id="stopBtn" class="btn btn-dark" style="display:none">ðŸ›‘ Stop SOS</button>

    <div class="row">
      <div id="sosChip" class="chip">SOS: Inactive</div>
      <div id="recChip" class="chip">Recorder: Idle</div>
    </div>

    <footer>Best on Chrome Android. Place <code>alarm.mp3</code> in same folder.</footer>
  </div>

<script>
/* ====== CONFIG ====== */
const ALARM_FILE = "alarm.mp3"; // make sure this file exists next to index.html
const WA_RECIPIENTS = ""; // optional: "919812345678,919876543210" (no +). Leave empty to let user pick

/* ====== STATE ====== */
let alarmAudio = null;
let mediaRecorder = null;
let recordedChunks = [];
let cameraStream = null;
let micStream = null;
let isActive = false;

/* ====== UI ====== */
const activateBtn = document.getElementById("activateBtn");
const stopBtn = document.getElementById("stopBtn");
const sosChip = document.getElementById("sosChip");
const recChip = document.getElementById("recChip");

function setSosLabel(active){
  sosChip.textContent = active ? "SOS: Active" : "SOS: Inactive";
}
function setRecLabel(recording){
  recChip.textContent = recording ? "Recorder: Recording" : "Recorder: Idle";
}

/* ====== SAFE HELPERS ====== */
function toast(msg){
  // minimal toast fallback
  console.log("SafeSakhi:", msg);
  // use alert sparingly
  // alert(msg);
}

/* ====== MAIN ACTIVATION ====== */
activateBtn.addEventListener('click', async function onActivate(e){
  if (isActive) return;
  isActive = true;
  setSosLabel(true);
  activateBtn.style.display = "none";
  stopBtn.style.display = "block";

  // 1) Play alarm immediately (direct user click -> browser should allow)
  try {
    alarmAudio = new Audio(ALARM_FILE);
    alarmAudio.loop = true;
    alarmAudio.preload = "auto";
    // Attempt to play immediately. Await ensures we start before other async work.
    await alarmAudio.play();
    toast("Alarm started");
  } catch(err){
    console.error("Alarm play failed:", err);
    alert("Unable to play alarm. Please ensure phone is not in silent mode and reload the page.");
    // continue with other actions even if alarm fails
  }

  // 2) Start microphone recording (in background)
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(micStream);
    recordedChunks = [];
    mediaRecorder.ondataavailable = ev => { if (ev.data && ev.data.size) recordedChunks.push(ev.data); };
    mediaRecorder.onstop = () => {
      setRecLabel(false);
      // Optional: create download link for user
      const blob = new Blob(recordedChunks, { type: recordedChunks[0]?.type || "audio/webm" });
      const url = URL.createObjectURL(blob);
      // add link to page (safe, non-intrusive)
      const a = document.createElement("a");
      a.href = url;
      a.download = `safesakhi-recording-${Date.now()}.webm`;
      a.textContent = "Download last recording";
      a.style.display = "block";
      document.querySelector('.card').appendChild(a);
    };
    mediaRecorder.start();
    setRecLabel(true);
    toast("Recording started");
  } catch(err){
    console.warn("Microphone access denied or not available:", err);
    setRecLabel(false);
  }

  // 3) Try to turn on flashlight (torch) - best-effort
  (async function tryTorch(){
    try {
      // request camera with environment facing mode
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } });
      const track = cameraStream.getVideoTracks()[0];
      const cap = track.getCapabilities ? track.getCapabilities() : {};
      if (cap.torch) {
        await track.applyConstraints({ advanced: [{ torch: true }] });
        toast("Torch enabled");
      } else {
        // many devices don't report torch capability; try applyConstraints anyway (some browsers accept it)
        try {
          await track.applyConstraints({ advanced: [{ torch: true }] });
          toast("Torch attempted (may or may not be on)");
        } catch(e) {
          // not supported
          console.warn("Torch not supported/applyConstraints failed:", e);
          track.stop();
          cameraStream = null;
        }
      }
    } catch(err){
      console.warn("Torch/camera not available or permission denied:", err);
      if(cameraStream){
        cameraStream.getTracks().forEach(t=>t.stop());
        cameraStream = null;
      }
    }
  })();

  // 4) Fetch geolocation and then open WhatsApp with message
  (function sendWhatsAppWithLocation(){
    if (!navigator.geolocation){
      openWhatsAppWithMessage("ðŸš¨ SOS! I need help. (Location not available)");
      return;
    }
    // Use getCurrentPosition to get a fresh location
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const maps = `https://maps.google.com/?q=${lat},${lon}`;
      const message = `ðŸš¨ SOS! I need help.\nMy location: ${maps}\nSent from SafeSakhi (web)`;
      openWhatsAppWithMessage(message);
    }, err => {
      console.warn("Geolocation error:", err);
      openWhatsAppWithMessage("ðŸš¨ SOS! I need help. (Could not fetch location)");
    }, { enableHighAccuracy:true, timeout:10000 });
  })();

}); // end activate

/* ====== STOP ALL ====== */
stopBtn.addEventListener('click', function onStop(){
  // stop alarm
  if (alarmAudio){
    alarmAudio.pause();
    alarmAudio.currentTime = 0;
    alarmAudio = null;
  }
  // stop recording
  try {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
    }
    if (micStream){
      micStream.getTracks().forEach(t=>t.stop());
      micStream = null;
    }
  } catch(e){ console.warn("Error stopping recorder:", e); }

  // stop camera torch
  try {
    if (cameraStream){
      cameraStream.getTracks().forEach(t=>t.stop());
      cameraStream = null;
    }
  } catch(e){ console.warn("Error stopping camera:", e); }

  // UI
  isActive = false;
  setSosLabel(false);
  setRecLabel(false);
  activateBtn.style.display = "block";
  stopBtn.style.display = "none";
  toast("SOS stopped");
});

/* ====== WhatsApp helper ====== */
function openWhatsAppWithMessage(message){
  const encoded = encodeURIComponent(message);
  let url;
  if (WA_RECIPIENTS && WA_RECIPIENTS.trim() !== ""){
    // open to first recipient (wa.me supports only one)
    const first = WA_RECIPIENTS.split(",")[0].trim();
    url = `https://wa.me/${first}?text=${encoded}`;
  } else {
    // let user pick contacts (mobile will open app)
    url = `https://wa.me/?text=${encoded}`;
  }
  // Open in new tab/window; mobile will switch to WhatsApp app if installed
  window.open(url, "_blank");
}

/* ====== helpful hint: resume audio on user gesture if needed ====== */
// Some browsers mute audio until a user gesture. If user presses anywhere after page load, we keep audio unlocked.
document.addEventListener('click', () => {
  if (alarmAudio && alarmAudio.paused && isActive) {
    alarmAudio.play().catch(()=>{});
  }
}, { once: true });

</script>
</body>
    </html>
